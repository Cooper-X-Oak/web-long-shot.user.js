# 网页长图生成工具 - 架构设计与规划书

## 1. 项目概述 (Overview)

### 1.1 背景与目标
用户希望能够方便地将网页（特别是 GitHub 仓库页面）生成长图并分享。
目标是开发一个轻量级、低侵入性的工具，实现“一键生成长图”并支持保存或分享。

### 1.2 核心需求
*   **一键操作**：极简交互，降低用户心智负担。
*   **长图生成**：支持超过一屏的网页内容，需处理滚动和拼接。
*   **场景覆盖**：优先适配 GitHub，但架构需保留扩展性以支持其他网站。
*   **分享能力**：保存本地为基础，预留上传图床接口。

---

## 2. 技术方案评估 (Technical Feasibility Analysis)

针对“网页长截图”需求，评估以下四种主流方案：

| 方案 | 描述 | 优点 | 缺点 | 适用性 |
| :--- | :--- | :--- | :--- | :--- |
| **A. 油猴脚本** | 注入 JS 脚本 | 轻量、无需安装软件、跨平台、开发快 | 滚动截图实现复杂、受浏览器安全策略限制(CORS) | **高 (推荐)** |
| **B. 浏览器扩展** | Chrome/Edge 插件 | 权限高、可调用浏览器原生截图 API | 开发发布流程繁琐、用户需安装插件 | 中 |
| **C. 桌面应用** | Electron/Tauri | 性能强、完美渲染控制 (Puppeteer) | 太重、用户只是想截个图、分发成本高 | 低 |
| **D. 在线服务** | 输入 URL 生成 | 无需安装 | 无法截取登录态页面(私有库)、无法截取动态交互状态 | 低 |

### 2.1 结论
**采用方案 A (油猴脚本)**。
理由：
1.  用户明确提到“写一个油猴脚本也许不错”，符合用户预期。
2.  对于 GitHub 这种相对标准的网页，前端生成截图技术（Canvas）已相对成熟。
3.  开发周期短，便于快速验证 (MVP)。

---

## 3. 系统架构设计 (Architecture Design)

### 3.1 核心流程
1.  **注入 (Injection)**: 脚本检测当前域名，匹配后注入悬浮按钮或菜单项。
2.  **预处理 (Pre-processing)**: 
    *   锁定页面滚动。
    *   隐藏 `position: fixed` 的干扰元素（如顶部导航栏），避免在长图中重复出现。
3.  **捕获 (Capturing)**:
    *   **自动滚动**：程序控制页面向下滚动，触发懒加载图片渲染。
    *   **绘制**：使用 `html2canvas` 或 `modern-screenshot` 将 DOM 绘制为 Canvas。
4.  **后处理 (Post-processing)**:
    *   恢复页面原始状态（显示导航栏）。
    *   将 Canvas 转换为 Blob/DataURL。
5.  **输出 (Output)**:
    *   触发浏览器下载行为。

### 3.2 模块划分

```mermaid
graph TD
    User[用户] --> UI[UI 交互模块]
    UI --> Controller[主控制器]
    
    subgraph Core [核心引擎]
        Controller --> Scroller[自动滚动器]
        Controller --> Cleaner[DOM 清理器]
        Controller --> Painter[绘图引擎 (html2canvas)]
    end
    
    Painter --> Canvas[内存 Canvas]
    Canvas --> Exporter[导出模块]
    Exporter --> File[本地文件]
```

*   **UI Controller**: 负责渲染“生成长图”按钮，显示进度条（滚动进度/生成进度）。
*   **DOM Cleaner**: 负责在截图前给特定元素添加 `display: none` 或修改样式（针对 GitHub Header）。
*   **Auto Scroller**: 模拟用户滚动行为，确保视口外的图片资源被加载。
*   **Capture Engine**: 封装截图库，处理 Canvas 的跨域配置、缩放比例（Retina 屏支持）。

---

## 4. 关键技术难点与对策

### 4.1 懒加载与动态内容
*   **问题**：直接截图会导致视口下方图片空白。
*   **对策**：实现 `smooth scroll` 机制，脚本自动滚动到底部，每滚动一屏暂停 `200ms-500ms` 等待网络请求和渲染，然后再回滚到顶部进行截图（或者分段截图再拼接）。

### 4.2 固定定位元素 (Fixed Elements)
*   **问题**：GitHub 的 Header 是 `position: sticky/fixed`，长图生成时会在每一屏都出现，或者遮挡内容。
*   **对策**：
    *   策略 A：截图前临时将这些元素的 `position` 改为 `absolute` 或 `static`。
    *   策略 B：截图前直接隐藏 (`display: none`)，截图后恢复。
    *   *决策*：MVP 阶段采用策略 B（隐藏），实现简单且画面干净。

### 4.3 Canvas 尺寸限制
*   **问题**：浏览器对 Canvas 宽高有最大限制（通常 16384px 或更低）。超长 Issue 或 Readme 可能导致崩溃。
*   **对策**：
    *   检测高度，如果超过阈值，提醒用户或自动进行“分片下载”（Image 1, Image 2...）。
    *   或者直接生成 PDF（使用 `jspdf`）。
    *   *MVP 决策*：暂不处理极端超长情况，优先保证普通长度可用。

### 4.4 跨域图片 (CORS)
*   **问题**：GitHub 用户头像或 Readme 中的外链图片可能跨域，导致 Canvas 污染（Tainted）无法导出。
*   **对策**：
    *   配置 `useCORS: true`。
    *   对于无法解决的跨域图片，接受“截图丢失图片”或“使用占位符”降级处理。

---

## 5. 开发计划 (Roadmap)

### Phase 1: 原型验证 (MVP)
*   [ ] 搭建油猴脚本基础模板。
*   [ ] 引入 `html2canvas` 库。
*   [ ] 在 GitHub 仓库页顶部注入按钮。
*   [ ] 实现可视区域截图并下载。
*   [ ] 实现全页面静态截图（不处理滚动懒加载）。

### Phase 2: 核心功能完善
*   [ ] 实现**自动滚动加载**逻辑。
*   [ ] 实现**Sticky 元素隐藏**逻辑（专门适配 GitHub）。
*   [ ] 添加进度提示 UI。

### Phase 3: 优化与扩展
*   [ ] 支持长图预览。
*   [ ] 优化图片体积与清晰度。
*   [ ] 适配更多网站规则。

---

## 6. 初始文件结构

```
/
├── README.md           # 项目说明
├── ARCHITECTURE.md     # 架构设计文档
├── src/
│   ├── main.js         # 脚本入口
│   ├── ui.js           # 界面相关
│   ├── capture.js      # 截图核心逻辑
│   ├── utils.js        # 工具函数
│   └── styles.css      # 注入的样式
└── dist/
    └── github-long-shot.user.js # 编译后的最终脚本
```
